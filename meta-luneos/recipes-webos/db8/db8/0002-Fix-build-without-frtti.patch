From ac43df230c3e43328b18c5cad9c65e536dad210e Mon Sep 17 00:00:00 2001
From: Martin Jansa <martin.jansa@gmail.com>
Date: Fri, 20 Oct 2023 23:53:47 +0000
Subject: [PATCH] Fix build without -frtti

* now with -fno-rtti to match leveldb it fails to build with:

FAILED: test/sandwich/CMakeFiles/gtest_sandwich.dir/SandwichPool.cpp.o
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot-native/usr/bin/x86_64-webos-linux/x86_64-webos-linux-g++ --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot -DBOOST_REGEX_DYN_LINK -DBOOST_REGEX_NO_LIB -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot/usr/include/glib-2.0 -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot/usr/lib/glib-2.0/include -I/include -I/usr/src/gtest/include -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/test/sandwich/../../src/storage-sandwich -isystem /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot/usr/src/gtest/include -isystem /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot/usr/src/gtest -m64 -march=nehalem -mtune=generic -mfpmath=sse -msse4.2  --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot  -O2 -pipe -g -feliminate-unused-debug-types -fcanon-prefix-map  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git=/usr/src/debug/db8/3.2.0-28+git-r40  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git=/usr/src/debug/db8/3.2.0-28+git-r40  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/build=/usr/src/debug/db8/3.2.0-28+git-r40  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/build=/usr/src/debug/db8/3.2.0-28+git-r40  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot=  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot=  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot-native=  -fvisibility-inlines-hidden -pthread -DUSE_PMLOG -DWITH_SNAPPY_COMPRESSION -Wall -Wextra -fPIC -Wconversion -std=c++14 -Wno-unused-but-set-variable -Wno-unused-variable -fno-exceptions -frename-registers -DMOJ_LINUX -fno-strict-aliasing -Wno-psabi -DMOJ_INTERNAL -D_REENTRANT -Werror=return-type -Wno-unused-parameter -Wno-empty-body -fno-exceptions -fno-rtti -Wl,--no-undefined -DWITH_SEARCH_QUERY_CACHE -DUSE_PMLOG_DECLARATION  -DMOJ_USE_LDB -DMOJ_USE_SANDWICH -DNDEBUG   -Wall -Wno-deprecated -pthread -std=c++14 -MD -MT test/sandwich/CMakeFiles/gtest_sandwich.dir/SandwichPool.cpp.o -MF test/sandwich/CMakeFiles/gtest_sandwich.dir/SandwichPool.cpp.o.d -o test/sandwich/CMakeFiles/gtest_sandwich.dir/SandwichPool.cpp.o -c /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/test/sandwich/SandwichPool.cpp
In file included from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDbShardInfo.h:21,
                 from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDbWatcher.h:23,
                 from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDbStorageEngine.h:24,
                 from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDbCursor.h:22,
                 from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDb.h:22,
                 from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/test/sandwich/SandwichPool.cpp:23:
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/core/MojSignal.h:38:24: warning: 'virtual MojErr MojSignalHandler::handleCancel()' was hidden [-Woverloaded-virtual=]
   38 |         virtual MojErr handleCancel();
      |                        ^~~~~~~~~~~~
In file included from /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDb.h:28:
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc/db/MojDbSpaceAlert.h:34:16: note:   by 'MojErr MojDbSpaceAlert::SpaceCheckHandler::handleCancel(MojServiceMessage*)'
   34 |         MojErr handleCancel(MojServiceMessage* msg);
      |                ^~~~~~~~~~~~
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/test/sandwich/SandwichPool.cpp: In lambda function:
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/test/sandwich/SandwichPool.cpp:305:43: error: 'dynamic_cast' not permitted with '-fno-rtti'
  305 |         MojDbSandwichItem &sandwichItem = dynamic_cast<MojDbSandwichItem &>(*item);
      |                                           ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

FAILED: src/core/CMakeFiles/mojocore.dir/MojObject.cpp.o
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot-native/usr/bin/x86_64-webos-linux/x86_64-webos-linux-g++ --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot -DBOOST_REGEX_DYN_LINK -DBOOST_REGEX_NO_LIB -Dmojocore_EXPORTS -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/inc -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot/usr/include/glib-2.0 -I/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot/usr/lib/glib-2.0/include -m64 -march=nehalem -mtune=generic -mfpmath=sse -msse4.2  --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot  -O2 -pipe -g -feliminate-unused-debug-types -fcanon-prefix-map  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git=/usr/src/debug/db8/3.2.0-28+git-r40  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git=/usr/src/debug/db8/3.2.0-28+git-r40  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/build=/usr/src/debug/db8/3.2.0-28+git-r40  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/build=/usr/src/debug/db8/3.2.0-28+git-r40  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot=  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot=  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/recipe-sysroot-native=  -fvisibility-inlines-hidden -pthread -DUSE_PMLOG -DWITH_SNAPPY_COMPRESSION -Wall -Wextra -fPIC -Wconversion -std=c++14 -Wno-unused-but-set-variable -Wno-unused-variable -fno-exceptions -frename-registers -DMOJ_LINUX -fno-strict-aliasing -Wno-psabi -DMOJ_INTERNAL -D_REENTRANT -Werror=return-type -Wno-unused-parameter -Wno-empty-body -fno-exceptions -fno-rtti -Wl,--no-undefined -DNDEBUG -fPIC -MD -MT src/core/CMakeFiles/mojocore.dir/MojObject.cpp.o -MF src/core/CMakeFiles/mojocore.dir/MojObject.cpp.o.d -o src/core/CMakeFiles/mojocore.dir/MojObject.cpp.o -c /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/src/core/MojObject.cpp
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/src/core/MojObject.cpp: In member function 'MojObject::ObjectImpl& MojObject::ensureObject()':
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/src/core/MojObject.cpp:527:18: error: 'dynamic_cast' not permitted with '-fno-rtti'
  527 |         myImpl = dynamic_cast<ObjectImpl*>(m_implementation);
      |                  ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/src/core/MojObject.cpp: In member function 'MojObject::ArrayImpl& MojObject::ensureArray()':
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/db8/3.2.0-28+git/git/src/core/MojObject.cpp:540:18: error: 'dynamic_cast' not permitted with '-fno-rtti'
  540 |         myImpl = dynamic_cast<ArrayImpl*>(m_implementation);
      |                  ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Signed-off-by: Martin Jansa <martin.jansa@gmail.com>
---
Upstream-Status: Pending

 src/core/MojObject.cpp         | 4 ++--
 test/sandwich/SandwichPool.cpp | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/core/MojObject.cpp b/src/core/MojObject.cpp
index 9527c45..f256925 100644
--- a/src/core/MojObject.cpp
+++ b/src/core/MojObject.cpp
@@ -524,7 +524,7 @@ MojObject::ObjectImpl& MojObject::ensureObject()
         myImpl = new ObjectImpl();
         m_implementation = myImpl;
     } else {
-        myImpl = dynamic_cast<ObjectImpl*>(m_implementation);
+        myImpl = static_cast<ObjectImpl*>(m_implementation);
     }
     return *myImpl;
 }
@@ -537,7 +537,7 @@ MojObject::ArrayImpl& MojObject::ensureArray()
         myImpl = new ArrayImpl();
         m_implementation = myImpl;
     } else {
-        myImpl = dynamic_cast<ArrayImpl*>(m_implementation);
+        myImpl = static_cast<ArrayImpl*>(m_implementation);
     }
     return *myImpl;
 }
diff --git a/test/sandwich/SandwichPool.cpp b/test/sandwich/SandwichPool.cpp
index 79382e0..b987b26 100644
--- a/test/sandwich/SandwichPool.cpp
+++ b/test/sandwich/SandwichPool.cpp
@@ -302,7 +302,7 @@ TEST_F(UnmountTest, unmount_shard_in_txn)
 
     MojRefCountedPtr<MojDbStorageItem> item;
     auto itemData = [&] {
-        MojDbSandwichItem &sandwichItem = dynamic_cast<MojDbSandwichItem &>(*item);
+        MojDbSandwichItem &sandwichItem = static_cast<MojDbSandwichItem &>(*item);
         return std::string { (const char *)sandwichItem.data(), sandwichItem.size() };
     };
 
