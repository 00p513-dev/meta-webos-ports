From 1cce14a3d303bce10871cebb702c394d3a5615d5 Mon Sep 17 00:00:00 2001
From: Martin Jansa <martin.jansa@gmail.com>
Date: Fri, 20 Oct 2023 23:12:27 +0000
Subject: [PATCH] Fix build with leveldb-1.23

* explicitly disable rtti like leveldb does since:
  https://github.com/google/leveldb/commit/69061b464ab1da287da9b7ffec1ed911b754403b
  to fix:

FAILED: mksandwich
: && /OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot-native/usr/bin/x86_64-webos-linux/x86_64-webos-linux-g++ --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot -m64 -march=nehalem -mtune=generic -mfpmath=sse -msse4.2  --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot  -O2 -pipe -g -feliminate-unused-debug-types -fcanon-prefix-map  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot-native=  -fvisibility-inlines-hidden -std=c++14 -Wall -Wextra -Wconversion -Werror  -m64 -march=nehalem -mtune=generic -mfpmath=sse -msse4.2  --sysroot=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot  -O2 -pipe -g -feliminate-unused-debug-types -fcanon-prefix-map  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot-native=  -fvisibility-inlines-hidden -Wl,-O1 -Wl,--hash-style=gnu -Wl,--as-needed -fcanon-prefix-map  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot-native=  -Wl,-O1 -Wl,--hash-style=gnu -Wl,--as-needed -fcanon-prefix-map  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/git=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/build=/usr/src/debug/leveldb-tl/1.0.6+git-r0  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fmacro-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot=  -fdebug-prefix-map=/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot-native=  -rdynamic CMakeFiles/mksandwich.dir/mksandwich.cpp.o -o mksandwich  lib/libgtest.a  lib/libgtest_main.a  -lleveldb  -lsnappy  lib/libgtest.a && :
/OE/build/luneos-scarthgap/tmp-glibc/work/corei7-64-webos-linux/leveldb-tl/1.0.6+git/recipe-sysroot-native/usr/bin/x86_64-webos-linux/../../libexec/x86_64-webos-linux/gcc/x86_64-webos-linux/13.2.0/ld: CMakeFiles/mksandwich.dir/mksandwich.cpp.o:(.rodata._ZTIN7leveldb10AsIteratorINS_10SandwichDBINS_8BottomDBEtE4Part6WalkerEEE[_ZTIN7leveldb10AsIteratorINS_10SandwichDBINS_8BottomDBEtE4Part6WalkerEEE]+0x10): undefined reference to `typeinfo for leveldb::Iterator'
collect2: error: ld returned 1 exit status

Signed-off-by: Martin Jansa <martin.jansa@gmail.com>
---
Upstream-Status: Pending

 CMakeLists.txt | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 6a0e81f..63fa2ce 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -41,6 +41,30 @@ endif()
 set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++14")
 set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wconversion -Werror")
 
+if(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
+  # Disable C++ exceptions.
+  string(REGEX REPLACE "/EH[a-z]+" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
+  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /EHs-c-")
+  add_definitions(-D_HAS_EXCEPTIONS=0)
+
+  # Disable RTTI.
+  string(REGEX REPLACE "/GR" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
+  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /GR-")
+else(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
+  # Enable strict prototype warnings for C code in clang and gcc.
+  if(NOT CMAKE_C_FLAGS MATCHES "-Wstrict-prototypes")
+    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wstrict-prototypes")
+  endif(NOT CMAKE_C_FLAGS MATCHES "-Wstrict-prototypes")
+
+  # Disable C++ exceptions.
+  string(REGEX REPLACE "-fexceptions" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
+  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fno-exceptions")
+
+  # Disable RTTI.
+  string(REGEX REPLACE "-frtti" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
+  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fno-rtti")
+endif(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
+
 include_directories(include)
 include_directories(${LevelDB_INCLUDE_DIRS})
 
