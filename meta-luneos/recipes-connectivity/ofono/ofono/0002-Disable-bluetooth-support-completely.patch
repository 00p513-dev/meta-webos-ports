From 67cfdabe5e8927cb0e4195fc1454cf5b6520d7dc Mon Sep 17 00:00:00 2001
From: Simon Busch <morphis@gravedo.de>
Date: Wed, 26 Nov 2014 11:19:03 +0100
Subject: [PATCH 2/4] Disable bluetooth support completely

When the handsfree audio manager is initialized it requires the kernel to support the
bluetooth stack but in some cases it does not and therefor we only enable it conditionally
to not waste startup time with waiting for something which isn't available.

Signed-off-by: Simon Busch <morphis@gravedo.de>
---
 ofono/Makefile.am | 5 ++++-
 ofono/src/main.c  | 6 ++++++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/ofono/Makefile.am b/ofono/Makefile.am
index 4f3de65..ba3ff87 100644
--- a/ofono/Makefile.am
+++ b/ofono/Makefile.am
@@ -518,7 +518,6 @@ builtin_modules += dun_gw_bluez5
 builtin_sources += plugins/dun_gw_bluez5.c plugins/bluez5.h
 endif
 endif
-endif
 
 if NETTIME
 builtin_modules += nettime
@@ -629,6 +628,10 @@ AM_CFLAGS = @DBUS_CFLAGS@ @GLIB_CFLAGS@ $(builtin_cflags) \
 					-DOFONO_PLUGIN_BUILTIN \
 					-DPLUGINDIR=\""$(build_plugindir)"\"
 
+if BLUETOOTH
+AM_CFLAGS += -DENABLE_BLUETOOTH
+endif
+
 AM_CPPFLAGS = -I$(builddir)/include -I$(builddir)/src -I$(srcdir)/src \
 			-I$(srcdir)/gdbus -I$(srcdir)/gisi -I$(srcdir)/gatchat \
 			-I$(srcdir)/btio -I$(srcdir)/gril
diff --git a/ofono/src/main.c b/ofono/src/main.c
index 81fea55..dc96fb5 100644
--- a/ofono/src/main.c
+++ b/ofono/src/main.c
@@ -244,11 +244,14 @@ int main(int argc, char **argv)
 
 	__ofono_manager_init();
 
+#ifdef ENABLE_BLUETOOTH
 	/*
 	 * BT HFP SCO socket creation moved to Bluez5 plugin.
 	 * Bluez4 handles the SCO socket, it will conflict with oFono.
 	 */
 	//__ofono_handsfree_audio_manager_init();
+	__ofono_handsfree_audio_manager_init();
+#endif
 
 	__ofono_plugin_init(option_plugin, option_noplugin);
 
@@ -259,7 +262,10 @@ int main(int argc, char **argv)
 
 	__ofono_plugin_cleanup();
 
+#ifdef ENABLE_BLUETOOTH
 	//__ofono_handsfree_audio_manager_cleanup(); See comment above
+	__ofono_handsfree_audio_manager_cleanup();
+#endif
 
 	__ofono_manager_cleanup();
 
-- 
2.1.4

